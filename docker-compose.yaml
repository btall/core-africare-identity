services:
  # postgres:
  #   image: postgres:18
  #   container_name: core-africare-identity-postgres
  #   environment:
  #     POSTGRES_DB: core-africare-identity
  #     POSTGRES_USER: core-africare-identity
  #     POSTGRES_PASSWORD: vd8bveedbnBpMcYr_8qB6A
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - core_africare_identity_postgres_data:/var/lib/postgresql/data
  #     - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
  #   networks:
  #     - africare-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U core-africare-identity"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # redis:
  #   image: redis:7-alpine
  #   container_name: core-africare-identity-redis
  #   command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - core_africare_identity_redis_data:/data
  #   networks:
  #     - africare-network
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # HAPI FHIR Server - Source of truth pour données démographiques Patient/Professional
  # hapi-fhir:
  #   image: hapiproject/hapi:latest
  #   container_name: core-africare-identity-hapi-fhir
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     # Configuration JSON FHIR R4
  #     hapi.fhir.default_encoding: json
  #     hapi.fhir.fhir_version: R4
  #     # Désactiver la validation stricte pour dev (activer en prod)
  #     hapi.fhir.validation.enabled: "false"
  #     # Base de données H2 embarquée pour dev (PostgreSQL en prod)
  #     spring.datasource.url: jdbc:h2:mem:hapi;DB_CLOSE_DELAY=-1
  #     spring.datasource.driver-class-name: org.h2.Driver
  #     # Activer le mode serveur ouvert pour dev (sécuriser en prod)
  #     hapi.fhir.openapi_enabled: "true"
  #   volumes:
  #     - core_africare_identity_hapi_data:/data/hapi
  #   networks:
  #     - africare-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/fhir/metadata"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 60s

  # Service Alembic pour migrations de base de données
  alembic:
    build: .
    container_name: core-africare-identity-alembic
    # docker-compose --profile migration run --rm alembic <commande> [arguments]
    entrypoint: ["alembic"]
    environment:
      # Impossible to run alembic without this variable
      PYTHONPATH: /home/app/web
      # PostgreSQL Database (externe) - SEULE VARIABLE UTILISÉE
      SQLALCHEMY_DATABASE_URI: postgresql+asyncpg://core-africare-identity:vd8bveedbnBpMcYr_8qB6A@host.docker.internal:5432/core-africare-identity

      # Autres variables minimales pour Alembic (requises par Settings mais non utilisées pour migrations)
      KEYCLOAK_SERVER_URL: http://localhost:8080/auth
      KEYCLOAK_REALM: dummy-realm
      KEYCLOAK_CLIENT_ID: dummy-client
      WEBHOOK_SECRET: dummy-webhook-secret-for-alembic
      OTEL_SERVICE_NAME: core-africare-identity-alembic
      OTEL_EXPORTER_OTLP_ENDPOINT: http://localhost:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      OTEL_EXPORTER_OTLP_INSECURE: "true"
    volumes:
      - .:/home/app/web
    networks:
      - africare-network
    profiles:
      - migration

  # core-africare-identity:
  #   build: .
  #   container_name: core-africare-identity
  #   command:
  #     - "uvicorn"
  #     - "app.main:app"
  #     - "--reload"
  #     - "--host"
  #     - "0.0.0.0"
  #     - "--port"
  #     - "8000"
  #   ports:
  #     - "8001:8000"
  #   volumes:
  #     - .:/home/app/web
  #   environment:
  #     # Service Identity
  #     API_GATEWAY_URL: http://api-gateway-service:8000
  #     ENVIRONMENT: development
  #     DEBUG: "false"
  #     # PostgreSQL Database
  #     SQLALCHEMY_DATABASE_URI: postgresql+asyncpg://core-africare-identity:vd8bveedbnBpMcYr_8qB6A@postgres:5432/core-africare-identity
  #     # Redis Messaging (Phase 1 MVP)
  #     REDIS_URL: redis://redis:6379
  #     REDIS_DB: 0
  #     # Keycloak Authentication
  #     KEYCLOAK_SERVER_URL: https://keycloak.africare.app/auth
  #     KEYCLOAK_REALM: africare
  #     KEYCLOAK_CLIENT_ID: core-africare-identity
  #     KEYCLOAK_CLIENT_SECRET: cYRi-B9OO2Ufd1h1n1SduA
  #     # OpenTelemetry
  #     OTEL_SERVICE_NAME: core-africare-identity
  #     OTEL_EXPORTER_OTLP_ENDPOINT: http://grafana-otel:4317
  #     OTEL_EXPORTER_OTLP_PROTOCOL: grpc
  #     OTEL_EXPORTER_OTLP_INSECURE: "true"
  #     OTEL_LOGS_EXPORTER: otlp
  #     OTEL_TRACES_EXPORTER: otlp
  #     OTEL_METRICS_EXPORTER: otlp
  #     OTEL_LOG_LEVEL: info
  #     # OpenTelemetry Python logging
  #     OTEL_PYTHON_LOG_LEVEL: info
  #     OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"
  #     OTEL_PYTHON_LOG_CORRELATION: "true"
  #     # CORS
  #     ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:4200,https://app.africare.sn"
  #     TRUSTED_HOSTS: "localhost,127.0.0.1,app.africare.sn,*.africare.sn"
  #     # Internationalisation (i18n)
  #     SUPPORTED_LOCALES: "fr,en"
  #     DEFAULT_LOCALE: fr
  #   depends_on:
  #     - postgres
  #     - redis
  #   networks:
  #     - africare-network

volumes:
  core_africare_identity_postgres_data:
  core_africare_identity_redis_data:
  core_africare_identity_hapi_data:

networks:
  africare-network:
    driver: bridge
